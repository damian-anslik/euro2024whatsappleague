{% extends 'base.html' %}

{% block content %}
<div class="league-container">

    <h3>üèÜ Leaderboard</h3>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Position</th>
                    <th>Name</th>
                    <th>Points</th>
                    <th>Last 5 Matches</th>
                    <!-- <th>DPs Remaining</th> -->
                </tr>
            </thead>
            <tbody>
                {% for user in standings %}
                <tr id="{{user.rank}}">
                    <td>{{user.rank}}</td>
                    <td>{{user.name}}</td>
                    <td>
                        {{user.points}}
                        {% if user.potential_points %}
                        (+{{ user.potential_points}})
                        {% endif %}
                    </td>
                    <td>
                        <div class="matches">
                            {% for points in user.points_in_last_n_finished_matches %}
                            <span id={{"incorrect" if not points else "correct-score" if points in [5, 10]
                                else "correct-margin" if points in [3, 6] else "correct-winner" if points in [1, 2] }}>
                                {{ points if points else 0}}
                            </span>
                            {% endfor %}
                        </div>
                    </td>
                    <!-- <td>{{user.num_wildcards_remaining}}</td> -->
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="loading-indicator-container">
        <div class="loading-indicator"></div>
    </div>
    <div class="ongoing-fixtures" hidden>
        <h3>‚öΩ Ongoing Matches</h3>
    </div>
    <div class="upcoming-fixtures" hidden>
        <h3>‚öΩ Upcoming Matches</h3>
    </div>
    <div class="finished-fixtures" hidden>
        <h3>‚öΩ Finished Matches</h3>
    </div><!-- Game overlay -->
    <div id="gameOverlay" style="
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:#0a0a0aee;
  z-index:9999;
  text-align:center;
">
        <div style="color:white; font-size:20px; margin-top:10px;">
            Score: <span id="score">0</span>
        </div>
        <canvas id="goalGame" width="400" height="600"
            style="margin-top:10px; background:green; border:2px solid white;"></canvas>
        <br>
        <button onclick="closeGame()" style="margin-top:10px; padding:10px 20px;">Exit</button>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll("h3").forEach(h => {
                if (h.textContent.includes("‚öΩ")) {
                    h.addEventListener("click", startGame);
                    h.style.cursor = "pointer";
                }
            });
        });

        let ctx, ball, keeper, score = 0;
        let running = false;

        function startGame() {
            document.getElementById("gameOverlay").style.display = "block";
            const canvas = document.getElementById("goalGame");
            ctx = canvas.getContext("2d");

            resetBall();
            keeper = { x: 150, y: 100, w: 100, h: 25, dir: 3 };
            score = 0;
            document.getElementById("score").textContent = score;

            canvas.onclick = (e) => {
                if (!ball.shot) {
                    const rect = canvas.getBoundingClientRect();
                    const tx = e.clientX - rect.left;
                    const ty = e.clientY - rect.top;
                    const dx = tx - ball.x;
                    const dy = ty - ball.y;
                    const length = Math.sqrt(dx * dx + dy * dy);
                    ball.vx = (dx / length) * 8;
                    ball.vy = (dy / length) * 8;
                    ball.shot = true;
                }
            };

            if (!running) {
                running = true;
                requestAnimationFrame(gameLoop);
            }
        }

        function resetBall() {
            ball = { x: 200, y: 550, r: 15, vx: 0, vy: 0, shot: false };
        }

        function closeGame() {
            document.getElementById("gameOverlay").style.display = "none";
            running = false; // stop loop
        }

        function drawSoccerBall(x, y, r) {
            ctx.fillStyle = "white";
            ctx.beginPath();
            ctx.arc(x, y, r, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = "black";
            ctx.lineWidth = 2;
            ctx.stroke();

            ctx.fillStyle = "black";
            for (let i = 0; i < 5; i++) {
                let angle = (i * 72) * Math.PI / 180;
                let px = x + Math.cos(angle) * r * 0.5;
                let py = y + Math.sin(angle) * r * 0.5;
                ctx.beginPath();
                ctx.arc(px, py, r * 0.2, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function drawKeeper(k) {
            ctx.fillStyle = "#1e90ff";
            ctx.strokeStyle = "white";
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.roundRect(k.x, k.y, k.w, k.h, 8);
            ctx.fill();
            ctx.stroke();
        }

        function drawGoal() {
            ctx.strokeStyle = "white";
            ctx.lineWidth = 5;
            ctx.beginPath();
            ctx.moveTo(50, 80);
            ctx.lineTo(350, 80);
            ctx.lineTo(350, 40);
            ctx.moveTo(50, 80);
            ctx.lineTo(50, 40);
            ctx.stroke();
        }

        function gameLoop() {
            if (!running) return;

            ctx.clearRect(0, 0, 400, 600);

            drawGoal();
            drawKeeper(keeper);

            keeper.x += keeper.dir;
            if (keeper.x <= 50 || keeper.x + keeper.w >= 350) keeper.dir *= -1;

            drawSoccerBall(ball.x, ball.y, ball.r);

            if (ball.shot) {
                ball.x += ball.vx;
                ball.y += ball.vy;

                if (ball.y - ball.r <= keeper.y + keeper.h &&
                    ball.y + ball.r >= keeper.y &&
                    ball.x + ball.r >= keeper.x &&
                    ball.x - ball.r <= keeper.x + keeper.w) {
                    setTimeout(resetBall, 500);
                    ball.shot = false;
                }
                else if (ball.y <= 80) {
                    if (ball.x >= 50 && ball.x <= 350) {
                        score++;
                        document.getElementById("score").textContent = score;
                    }
                    setTimeout(resetBall, 500);
                    ball.shot = false;
                }
                else if (ball.x < 0 || ball.x > 400 || ball.y < 0) {
                    setTimeout(resetBall, 500);
                    ball.shot = false;
                }
            }

            requestAnimationFrame(gameLoop);
        }
    </script>
    <script src="/static/scripts.js" defer></script>
</div>
{% endblock %}